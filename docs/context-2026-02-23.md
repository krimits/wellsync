# Context — Συνεδρία 2026-02-23

## Στόχος Συνεδρίας

Ενσωμάτωση RAG (Retrieval-Augmented Generation) με pgvector στην αρχιτεκτονική WellSync.

## Απόφαση: Full RAG με pgvector

**Σκεπτικό**: Το WellSync χρησιμοποιεί Claude claude-haiku-4-5-20251001 για συστάσεις, αλλά μέχρι σήμερα τα prompts περιείχαν μόνο user metrics. Η RAG ενσωμάτωση επιτρέπει evidence-based συστάσεις από curated wellness corpus (ACSM, ISSN, WHO, Sleep Foundation).

**Επιλογή pgvector έναντι αλλαγής**: Ο PostgreSQL χρησιμοποιείται ήδη στο project — το pgvector είναι extension, χωρίς νέα infrastructure.

**Embedding model**: `sentence-transformers/all-MiniLM-L6-v2` — 384 dimensions, free, local inference, ~90MB.

## Αλλαγές που Έγιναν (Πλήρης λίστα)

### docs/F1/wellsync-phi1-content.md

| Πεδίο | Αλλαγή |
|-------|--------|
| Πεδίο 6 — Καινοτομία | +4η καινοτομία: "Evidence-Based RAG" — pgvector cosine similarity, ACSM/WHO/ISSN/Sleep Foundation corpus |
| Πεδίο 9 — Τεχνολογία | Backend stack: `PostgreSQL + pgvector extension` + `sentence-transformers/all-MiniLM-L6-v2` |
| Πεδίο 12 — Executive Summary | Ενσωμάτωση RAG: "ανακτά σχετικές επιστημονικές οδηγίες (ACSM, WHO, Sleep Foundation) μέσω RAG (pgvector semantic search)" |

### docs/F2/wellsync-phi2-slides.md + wellsync-phi2-speaker-script.md

| Slide | Αλλαγή |
|-------|--------|
| SLIDE 6 — Agentic Loop | Flow diagram: + `RAG: top-2 scientific guidelines` βήμα πριν Claude API |
| SLIDE 6 — Bullets | + "ML + επιστημονικές οδηγίες (ACSM/WHO) + Claude AI → evidence-based output" |
| SLIDE 9 — Tech Stack | Backend: + `PostgreSQL + pgvector`, + `sentence-transformers (semantic embeddings)` |
| Speaker script SLIDE 6 | Νέο κείμενο: "Από οργανισμούς όπως ο ACSM και ο WHO... Η σύσταση δεν είναι απλά AI output — είναι evidence-based" |
| Speaker script SLIDE 9 | Νέο κείμενο: pgvector explanation + "Ο συνδυασμός ML + RAG + Claude AI είναι το highlight" |

### docs/F3/wellsync-phi3-technical-design.md

| Section | Αλλαγή |
|---------|--------|
| 3.1 Tech Stack | +2 γραμμές: pgvector, sentence-transformers |
| 3.2 Architecture Diagram | WellnessRetriever (RAG layer) κάτω από PostgreSQL |
| 3.3 Agentic Loop Data Flow | RAG retrieval step (k=2) πριν το Claude API |
| 3.4 DB Schema | 6ος πίνακας: knowledge_chunks(id, category, content, embedding vector(384), source) + ivfflat index |
| 2.1 FR-07 | Updated acceptance criteria: recommendation MUST incorporate evidence from knowledge base |

### Νέα Αρχεία (Φ4 έτοιμα)

```
backend/
└── knowledge/
    ├── __init__.py
    ├── retriever.py       # WellnessRetriever class — pgvector cosine similarity
    ├── ingest.py          # One-time ingestion: corpus/*.txt → embed → insert
    └── corpus/            # 27 curated wellness snippets
        ├── sleep_01–07.txt    (7 αρχεία — Sleep Foundation, Matthew Walker)
        ├── exercise_01–09.txt (9 αρχεία — ACSM 2022/2023)
        ├── nutrition_01–07.txt (7 αρχεία — ISSN, WHO)
        └── stress_01–05.txt   (5 αρχεία — WHO, Kabat-Zinn)

migrations/
└── add_knowledge_chunks.sql   # pgvector ext + table + ivfflat index
```

## RAG Data Flow (Φ4)

```
MorningRecommendationAgent.handle(event, db)
    │
    ├── 1. Fetch today's check-in + compute readiness_score
    │
    ├── 2. RAG Retrieval [NEW]
    │       query = f"sleep {sleep_hours}h quality {sleep_quality}/5 stress {stress}/5 readiness {readiness_score:.0f}"
    │       knowledge = WellnessRetriever(db).retrieve(query, k=2)
    │       → pgvector cosine similarity → 2 most relevant guideline chunks
    │
    ├── 3. Build enriched prompt
    │       base: user metrics + 7-day history (~350 tokens)
    │       + "Relevant wellness guidelines:\n- [chunk1]\n- [chunk2]" (~100 tokens)
    │       total: ~450 tokens < 600 token budget ✅
    │
    └── 4. Claude API → evidence-based recommendation (≤ 200 tokens)
```

## Pending για Φ4 (όταν αρχίσει ο κώδικας)

1. **docker-compose.yml**: αλλαγή `image: postgres:16` → `image: pgvector/pgvector:pg16`
2. **requirements.txt**: προσθήκη `sentence-transformers>=2.2.0` και `pgvector>=0.2.0`
3. **backend/agents/morning_agent.py**: import + call `WellnessRetriever` (~15 γραμμές)
4. **Εκτέλεση migration**: `psql $DATABASE_URL -f migrations/add_knowledge_chunks.sql`
5. **Εκτέλεση ingestion**: `python -m backend.knowledge.ingest` (one-time)

## Corpus Stats

| Κατηγορία | Αρχεία | Πηγές |
|-----------|--------|-------|
| sleep | 7 | Sleep Foundation, Matthew Walker, Harvard Med |
| exercise | 9 | ACSM (2022, 2023) |
| nutrition | 7 | ISSN (2017, 2021), WHO, British Nutrition Foundation |
| stress | 5 | WHO (2016, 2022), Kabat-Zinn, Benson |
| **ΣΥΝΟΛΟ** | **27** | |

## Τι ΔΕΝ Άλλαξε

- Το ίδιο το Φ3 document δεν αλλάζει δομικά — μόνο 5 σημεία ενημερώθηκαν
- Τα UI mockups αμετάβλητα (το RAG είναι backend-only)
- Όλα τα υπόλοιπα FR (FR-01 έως FR-06, FR-08–FR-10) αμετάβλητα
- Ο αριθμός Docker containers αμετάβλητος (3: db, backend, frontend)

## Για την Επόμενη Συνεδρία

**Αμεσες προτεραιότητες (deadline order):**
1. Φ1 — Άνοιξε eclass φόρμα, αντέγραψε `docs/F1/wellsync-phi1-content.md`, βάλε ονόματα, export PDF (deadline 14/3)
2. Φ2 — Δημιούργησε 11 slides στο Canva χρησιμοποιώντας `docs/F2/wellsync-phi2-speaker-script.md` (Part B = design guide) (deadline 16-26/3)
3. Φ3 — Βάλε ονόματα ομάδας στο header του Φ3 document και export PDF (deadline 20-23/4)

**Για να συνεχίσεις τη Φ4 (Μάιος):**
```bash
# 1. Εκτέλεσε migration
psql $DATABASE_URL -f migrations/add_knowledge_chunks.sql

# 2. Ενσωμάτωσε στον MorningRecommendationAgent (morning_agent.py):
from backend.knowledge.retriever import WellnessRetriever
retriever = WellnessRetriever(db)
query = f"sleep {checkin.sleep_hours}h quality {checkin.sleep_quality}/5 stress {checkin.stress}/5 readiness {readiness_score:.0f}"
knowledge = retriever.retrieve(query, k=2)
# Περάσ' το στο build_recommendation_prompt(... knowledge_context=knowledge)

# 3. Εκτέλεσε ingestion (one-time)
python -m backend.knowledge.ingest

# 4. docker-compose.yml: postgres:16 → pgvector/pgvector:pg16
# 5. requirements.txt: + sentence-transformers>=2.2.0, pgvector>=0.2.0
```

## Project State Fingerprint (2026-02-23 — FINAL)

```
Φ1: READY + RAG SYNCED (Πεδία 6, 9, 12 ενημερώθηκαν — pending: names + upload)
Φ2: READY + RAG SYNCED (SLIDE 6 + SLIDE 9 + speaker script — pending: Canva)
Φ3: READY + RAG (5 sections updated — pending: names + PDF)
Φ4: SKELETON READY (RAG files, corpus/27, migration — code starts May)
Git: NO REPO YET (create before Φ4)
Code: ZERO lines written
RAG: Consistent across Φ1 + Φ2 + Φ3 documents ✅
```
